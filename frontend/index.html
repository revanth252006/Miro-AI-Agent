<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIRO | AI Agent</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>

    <script>
        tailwind.config = { theme: { extend: { colors: { miro: { bg: '#050505', glass: 'rgba(255, 255, 255, 0.05)', accent: '#00f3ff', purple: '#bd00ff' } }, fontFamily: { sans: ['Space Grotesk', 'sans-serif'] }, animation: { 'float': 'float 6s ease-in-out infinite' }, keyframes: { float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } } } } } }
        mermaid.initialize({ startOnLoad: false, theme: 'dark' });
    </script>

    <style>
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: #050505; } ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        .glass-panel { background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .msg-user { background: linear-gradient(135deg, #00f3ff22, #00f3ff05); border: 1px solid #00f3ff44; color: #e0f2fe; border-bottom-right-radius: 2px; }
        .msg-ai { background: #1a1a1a; border: 1px solid #333; color: #d1d5db; border-bottom-left-radius: 2px; max-width: 90%; }
        .mermaid { background: #111; padding: 15px; border-radius: 8px; margin: 10px 0; text-align: center; border: 1px solid #333; }
        pre { background: #0d0d0d !important; border-radius: 8px; border: 1px solid #333; margin: 10px 0; padding: 12px; overflow-x: auto; }
        code { font-family: 'Fira Code', monospace; font-size: 0.9em; }
        .typing-dot { width: 6px; height: 6px; background-color: #00f3ff; border-radius: 50%; animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; } .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        #voice-overlay { transition: opacity 0.3s ease; }
        .voice-orb { width: 120px; height: 120px; background: radial-gradient(circle, rgba(0,243,255,0.8) 0%, rgba(189,0,255,0.4) 60%, transparent 80%); border-radius: 50%; filter: blur(10px); animation: pulse-glow 2s infinite; }
        @keyframes pulse-glow { 0% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 0.8; } }
        #vision-container { display: none; position: absolute; bottom: 130px; right: 20px; width: 240px; height: 180px; background: #000; border: 2px solid #00f3ff; border-radius: 12px; overflow: hidden; z-index: 40; }
        video { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body class="bg-miro-bg text-white h-screen flex overflow-hidden">

    <input type="file" id="file-upload" class="hidden" accept=".pdf,.txt">
    <div id="vision-container"><video id="webcam" autoplay playsinline></video><div class="absolute bottom-2 left-2 bg-black/80 text-miro-accent text-[10px] font-bold px-2 py-1 rounded">‚óè VISION ACTIVE</div></div>

    <aside class="w-64 hidden md:flex flex-col border-r border-miro-glassBorder bg-black/40">
        <div class="p-6 flex items-center gap-3">
            <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-miro-accent to-miro-purple animate-pulse-slow"></div>
            <h1 class="text-2xl font-bold tracking-widest">MIRO</h1>
        </div>
        <div class="flex-1 overflow-y-auto p-4"><div class="text-xs font-semibold text-gray-500 uppercase mb-2">Status</div><div class="text-xs text-gray-400 p-2 bg-white/5 rounded border border-white/5">System: <span class="text-green-400">Online</span><br>Engine: <span class="text-miro-accent">MIRO PRO </span></div></div>
    </aside>

    <main class="flex-1 flex flex-col relative z-10 h-full">
        <header class="h-16 flex items-center justify-between px-6 bg-miro-bg/80 backdrop-blur-md sticky top-0 z-20">

            <div class="flex items-center gap-2 px-3 py-1 rounded-full bg-miro-accent/10 border border-miro-accent/20"><i class="fa-solid fa-bolt text-miro-accent text-xs"></i><span class="text-xs font-medium text-miro-accent tracking-wide">MIRO</span></div>
            <!-- <button id="lang-btn" onclick="toggleLanguage()" class="px-3 py-1 text-xs font-bold rounded-full bg-gray-800 border border-gray-600 hover:border-miro-accent transition">üá∫üá∏ English</button> -->
        </header>

        <div id="chat-wrapper" class="flex-1 overflow-y-auto p-4 md:p-6 scroll-smooth relative">
            <div id="chat-container" class="max-w-4xl mx-auto space-y-6 pb-4">
                <div class="flex flex-col items-center justify-center h-48 text-center space-y-4 opacity-80 mt-10">
                    <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-gray-800 to-black border border-gray-700 flex items-center justify-center text-3xl shadow-2xl animate-float">‚ú®</div>
                    <h2 class="text-3xl font-light">Hello, <span class="font-bold text-transparent bg-clip-text bg-gradient-to-r from-miro-accent to-white" id="user-display-name">Revanth</span></h2>
                </div>
            </div>
        </div>

        <div class="p-4 md:p-6 bg-miro-bg/90 backdrop-blur-lg ">
            <div id="feature-picker" class="absolute bottom-24 left-6 z-30 glass-panel rounded-2xl p-4 w-72 shadow-2xl transition-all duration-300 translate-y-10 opacity-0 pointer-events-none scale-95 border border-miro-glassBorder">
                <div class="text-xs font-bold text-gray-500 uppercase mb-3 px-2">Tools</div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="triggerAction('Upload')" class="glass-button p-3 rounded-xl flex flex-col items-center gap-2 group"><i class="fa-solid fa-cloud-arrow-up text-xl text-blue-400"></i><span class="text-xs">Upload PDF</span></button>
                    <button onclick="triggerAction('Camera')" class="glass-button p-3 rounded-xl flex flex-col items-center gap-2 group"><i class="fa-solid fa-eye text-xl text-miro-accent"></i><span class="text-xs">Vision</span></button>
                    <button onclick="triggerAction('Sign')" class="glass-button p-3 rounded-xl flex flex-col items-center gap-2 group"><i class="fa-solid fa-hands-asl-interpreting text-xl text-purple-400"></i><span class="text-xs">Sign</span></button>
                    <button onclick="triggerAction('Mouse')" class="glass-button p-3 rounded-xl flex flex-col items-center gap-2 group"><i class="fa-solid fa-arrow-pointer text-xl text-green-400"></i><span class="text-xs">Mouse</span></button>
                </div>
                <div class="mt-2 pt-2 border-t border-gray-800">
                    <button onclick="triggerAction('Disconnect')" class="w-full p-2 rounded-lg bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/30 flex items-center justify-center gap-2 transition"><i class="fa-solid fa-power-off"></i> <span class="text-xs font-bold">Disconnect</span></button>
                </div>
            </div>

            <div class="max-w-4xl mx-auto glass-panel rounded-2xl p-2 flex items-end gap-2 shadow-lg">
                <button id="plus-btn" class="w-10 h-10 mb-1 rounded-xl bg-white/5 hover:bg-miro-accent/20 text-gray-400 transition flex items-center justify-center shrink-0"><i class="fa-solid fa-plus" id="plus-icon"></i></button>
                <textarea id="user-input" rows="1" placeholder="Message Miro..." class="flex-1 bg-transparent border-none outline-none text-white px-2 py-3 resize-none max-h-32 overflow-y-auto leading-relaxed placeholder-gray-500"></textarea>
                <button id="mic-btn" class="w-10 h-10 mb-1 rounded-xl hover:bg-white/10 text-gray-400 hover:text-miro-accent transition flex items-center justify-center shrink-0" onclick="toggleVoiceMode()"><i class="fa-solid fa-microphone text-lg"></i></button>
                <button id="send-btn" class="w-10 h-10 mb-1 rounded-xl bg-miro-accent text-black font-bold hover:shadow-[0_0_15px_rgba(0,243,255,0.4)] transition flex items-center justify-center shrink-0"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>

        <div id="voice-overlay" class="absolute inset-0 z-50 bg-black/90 backdrop-blur-xl flex flex-col items-center justify-center hidden">
            <button onclick="toggleVoiceMode()" class="absolute top-6 right-6 p-4 rounded-full bg-white/10 hover:bg-white/20 transition"><i class="fa-solid fa-xmark text-xl"></i></button>
            <div class="relative"><div class="voice-orb"></div><div class="absolute inset-0 flex items-center justify-center"><i class="fa-solid fa-microphone text-4xl text-white drop-shadow-lg"></i></div></div>
            <div class="mt-12 text-center space-y-4 px-4"><h2 id="voice-status" class="text-2xl font-light tracking-widest text-white">LISTENING...</h2><p id="voice-transcript" class="text-gray-400 text-lg max-w-2xl h-16 transition-all duration-300">Go ahead, I'm listening.</p></div>
        </div>
    </main>

    <script>
        const wsUrl = 'ws://localhost:8000/ws'; 
        let websocket = null, ttsEnabled = false, isVoiceMode = false, isAiSpeaking = false;
        let currentLang = 'en-US', recognition = null, visionActive = false, stream = null;
        let selectedVoice = null, silenceTimer = null;

        const userInput = document.getElementById("user-input");
        const chatContainer = document.getElementById("chat-container");
        const chatWrapper = document.getElementById("chat-wrapper");
        const video = document.getElementById("webcam");
        const visionContainer = document.getElementById("vision-container");

        // --- 1. VOICE ENGINE: FORCE ZIRA ---
        function loadVoices() {
            const voices = window.speechSynthesis.getVoices();
            if (voices.length === 0) return;
            selectedVoice = voices.find(v => v.name.includes("Zira")) || 
                            voices.find(v => v.name.includes("Google US English")) || 
                            voices[0];
        }
        window.speechSynthesis.onvoiceschanged = loadVoices;
        loadVoices(); 

        function speak(text) {
            if (!ttsEnabled) return;
            const cleanText = text.replace(/[*#`_]/g, '').replace(/<[^>]*>/g, '').replace(/```[\s\S]*?```/g, "Code block generated.");
            
            isAiSpeaking = true;
            window.speechSynthesis.cancel(); 
            // NOTE: We do NOT stop recognition. The mic stays ON.

            const u = new SpeechSynthesisUtterance(cleanText);
            const hasTelugu = /[\u0C00-\u0C7F]/.test(cleanText);
            if (hasTelugu) u.lang = 'te-IN';
            else if (selectedVoice) { u.voice = selectedVoice; u.lang = 'en-US'; }

            u.onend = () => { isAiSpeaking = false; if(isVoiceMode) document.getElementById('voice-status').innerText = "LISTENING..."; };
            window.speechSynthesis.speak(u);
        }

        // --- 2. FULL DUPLEX RECOGNITION (BARGE-IN ENABLED) ---
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true; // CRITICAL: NEVER STOP LISTENING
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                if(isVoiceMode) document.getElementById('voice-status').innerText = "LISTENING...";
            };

            recognition.onresult = (e) => {
                const result = e.results[e.results.length-1];
                const t = result[0].transcript.trim();
                const lower = t.toLowerCase();

                // 1. BARGE-IN LOGIC (Interrupt AI)
                if (isAiSpeaking && t.length > 2) {
                    window.speechSynthesis.cancel(); // Shut up the AI immediately
                    isAiSpeaking = false;
                    console.log("Interruption detected!");
                }

                // 2. Wake Word
                if(!isVoiceMode && (lower.includes("hey miro") || lower.includes("hello miro"))) {
                    toggleVoiceMode(); return;
                }

                if(isVoiceMode) {
                    document.getElementById('voice-transcript').innerText = `"${t}"`;
                    
                    // 3. SEND LOGIC
                    clearTimeout(silenceTimer);
                    
                    if(result.isFinal) {
                        handleVoiceCommand(t);
                    } else {
                        // If user pauses for 1s, we assume they are done.
                        // We use a shorter timer to make it feel snappier.
                        silenceTimer = setTimeout(() => {
                            if(t.length > 1) {
                                // Important: We manually abort to flush the buffer, then restart immediately
                                recognition.abort(); 
                                handleVoiceCommand(t);
                                setTimeout(() => { try{recognition.start();}catch(e){} }, 50);
                            }
                        }, 1000); 
                    }
                }
            };

            // Auto-restart loop
            recognition.onend = () => {
                if(isVoiceMode) try { recognition.start(); } catch(e){}
            };
        }

        function handleVoiceCommand(text) {
            if(!text || text.length < 2) return;
            document.getElementById('voice-status').innerText = "THINKING...";
            addUserMessage(text); 
            sendMessage(text);
        }

        function toggleVoiceMode() {
            isVoiceMode = !isVoiceMode;
            document.getElementById('voice-overlay').classList.toggle('hidden');
            if(isVoiceMode) { 
                const h = new Date().getHours();
                const g = h<12?"Good Morning":h<18?"Good Afternoon":"Good Evening";
                const n = document.getElementById('user-display-name').innerText;
                ttsEnabled=true; 
                speak(`${g}, ${n}. I am Miro.`); 
                try { recognition.start(); } catch(e){}
            } else { 
                ttsEnabled=false; isAiSpeaking=false; 
                window.speechSynthesis.cancel(); 
                try { recognition.stop(); } catch(e){} 
            }
        }

        // --- 3. FORMATTING ---
        function formatAndDisplayAiMessage(rawText) {
            removeLoadingIndicator();
            const div = document.createElement('div');
            div.className = "flex justify-start items-start gap-3 w-full";
            div.innerHTML = `<div class="w-8 h-8 rounded-full bg-gradient-to-br from-miro-accent to-miro-purple flex items-center justify-center shadow-lg mt-1 shrink-0"><i class="fa-solid fa-wand-magic-sparkles text-xs text-white"></i></div><div class="msg-ai px-5 py-3 rounded-2xl text-sm shadow-md leading-relaxed overflow-hidden w-full max-w-[85%]"></div>`;
            chatContainer.appendChild(div);
            const contentDiv = div.querySelector('.msg-ai');
            
            if (rawText.includes("```mermaid")) {
                const code = rawText.match(/```mermaid\n([\s\S]*?)```/)[1];
                const id = 'mermaid-' + Date.now();
                contentDiv.innerHTML = `<div class="mermaid" id="${id}">${code}</div>`;
                try { mermaid.init(undefined, document.getElementById(id)); } catch(e){}
            } else {
                contentDiv.innerHTML = marked.parse(rawText);
            }
            Prism.highlightAllUnder(contentDiv);
            scrollToBottom();
            if(isVoiceMode) speak(rawText);
        }

        // --- 4. NETWORK ---
        function connectWebSocket() {
            websocket = new WebSocket(wsUrl);
            websocket.onmessage = (event) => {
                formatAndDisplayAiMessage(event.data);
                if (event.data.includes("Vision Camera On")) startVisionMode();
                if (event.data.includes("Disconnected")) stopVisionMode();
            };
            websocket.onclose = () => setTimeout(connectWebSocket, 3000);
        }

        function sendMessage(text) {
            if (visionActive) {
                const canvas = document.createElement("canvas");
                canvas.width = 640; canvas.height = 480;
                canvas.getContext("2d").drawImage(video, 0, 0, 640, 480);
                websocket.send(JSON.stringify({ text: text, image: canvas.toDataURL("image/jpeg", 0.7) }));
            } else { websocket.send(text); }
        }

        // --- 5. UTILS ---
        async function startVisionMode() { try { stream = await navigator.mediaDevices.getUserMedia({ video: true }); video.srcObject = stream; visionContainer.style.display = "block"; visionActive = true; } catch(e){} }
        function stopVisionMode() { if(stream) stream.getTracks().forEach(t=>t.stop()); visionContainer.style.display = "none"; visionActive = false; }
        function scrollToBottom() { chatWrapper.scrollTo({ top: chatWrapper.scrollHeight, behavior: 'smooth' }); }
        
        function addUserMessage(text) {
            const div = document.createElement('div');
            div.className = "flex justify-end fade-in";
            div.innerHTML = `<div class="msg-user max-w-[85%] px-5 py-3 rounded-2xl text-sm shadow-md" style="white-space: pre-wrap;">${text}</div>`;
            chatContainer.appendChild(div); scrollToBottom(); showLoadingIndicator();
        }

        let loadingId = null;
        function showLoadingIndicator() { if(loadingId) return; loadingId='load-'+Date.now(); const d=document.createElement('div'); d.id=loadingId; d.className="flex justify-start items-center gap-3"; d.innerHTML=`<div class="w-8 h-8 rounded-full bg-gradient-to-br from-miro-accent to-miro-purple flex items-center justify-center shadow-lg mt-1 shrink-0"><i class="fa-solid fa-wand-magic-sparkles text-xs text-white"></i></div><div class="msg-ai px-4 py-3 rounded-2xl text-sm shadow-md flex items-center gap-1 h-10"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`; chatContainer.appendChild(d); scrollToBottom(); }
        function removeLoadingIndicator() { if(loadingId) { document.getElementById(loadingId)?.remove(); loadingId=null; } }

        const plusBtn = document.getElementById('plus-btn');
        const featurePicker = document.getElementById('feature-picker');
        plusBtn.addEventListener('click', () => { featurePicker.classList.toggle('opacity-0'); featurePicker.classList.toggle('pointer-events-none'); featurePicker.classList.toggle('translate-y-10'); document.getElementById('plus-icon').classList.toggle('rotate-45'); });

        window.triggerAction = (action) => {
            plusBtn.click();
            if (action === "Upload") { document.getElementById('file-upload').click(); return; } 
            if(action === 'Disconnect') { websocket.send("disconnect"); return; } 
            addUserMessage(`Activate ${action}`); websocket.send(`Activate ${action}`);
        };

        // --- 6. INPUT HANDLER FIX (SHIFT+ENTER) ---
        userInput.addEventListener('input', function() { this.style.height='auto'; this.style.height=(this.scrollHeight)+'px'; });
        
        // FIXED LOGIC FOR ENTER KEY
        userInput.addEventListener('keydown', (e) => { 
            if (e.key === 'Enter' && !e.shiftKey) { 
                e.preventDefault(); // Stop new line
                const text = userInput.value.trim();
                if(text) {
                    document.getElementById('send-btn').click();
                }
            } 
        });

        document.getElementById('send-btn').addEventListener('click', () => {
            const text = userInput.value.trim(); 
            if(!text) return;
            addUserMessage(text); 
            sendMessage(text); 
            userInput.value = ''; 
            userInput.style.height = 'auto';
        });

        document.getElementById("file-upload").addEventListener('change', (e) => { const f = e.target.files[0]; if(!f)return; const r = new FileReader(); r.onload = (ev) => { websocket.send(JSON.stringify({ type: "upload", filename: f.name, file: ev.target.result })); addUserMessage(`üìÇ Uploading ${f.name}...`); }; r.readAsDataURL(f); });

        connectWebSocket();
    </script>
</body>
</html>