<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIRO | AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>tailwind.config = { theme: { extend: { colors: { miro: { bg: '#050505', accent: '#00f3ff', purple: '#bd00ff', surface: '#121212' } }, fontFamily: { sans: ['Space Grotesk'] } } } }</script>
    <style>
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        .glass-panel { background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .glass-button { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.3s ease; }
        .glass-button:hover { border-color: #00f3ff; transform: translateY(-2px); }
        .msg-ai { background: #1a1a1a; border: 1px solid #333; color: #d1d5db; }
        .msg-user { background: linear-gradient(135deg, #00f3ff22, #00f3ff05); border: 1px solid #00f3ff44; color: #e0f2fe; }
        #vision-container { display: none; position: absolute; bottom: 100px; right: 20px; width: 240px; height: 180px; background: #000; border: 2px solid #00f3ff; border-radius: 12px; z-index: 40; }
        video { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body class="bg-miro-bg text-white h-screen flex overflow-hidden">
    <input type="file" id="file-upload" class="hidden" accept=".pdf,.txt,.mp4,.mp3,.jpg">
    <div id="vision-container"><video id="webcam" autoplay playsinline></video></div>

    <aside class="w-64 hidden md:flex flex-col border-r border-gray-800 bg-black/40">
        <div class="p-6 flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-miro-accent"></div><h1 class="text-2xl font-bold">MIRO</h1></div>
        <div class="flex-1 overflow-y-auto p-4" id="history-log"></div>
    </aside>

    <main class="flex-1 flex flex-col relative z-10">
        <header class="h-16 border-b border-gray-800 flex items-center justify-between px-6 bg-miro-bg/80 backdrop-blur-md">
            <div class="flex items-center gap-2"><i class="fa-solid fa-bolt text-miro-accent"></i><span class="text-xs font-bold text-miro-accent">ONLINE</span></div>
            <a href="http://localhost:8000/login" class="px-4 py-1 text-xs font-bold rounded-full bg-blue-600 hover:bg-blue-500 transition">G Login</a>
        </header>

        <div id="chat-view" class="flex-1 flex flex-col h-full relative">
            <div id="chat-container" class="flex-1 overflow-y-auto p-6 space-y-6">
                <div class="flex flex-col items-center justify-center h-64 text-center space-y-4 opacity-80 mt-10">
                    <h2 class="text-3xl font-light">Hello, <span class="font-bold text-transparent bg-clip-text bg-gradient-to-r from-miro-accent to-white" id="user-display-name">Guest</span></h2>
                </div>
            </div>

            <div class="p-4 md:p-6 pb-8 relative">
                <div id="feature-picker" class="absolute bottom-24 left-6 z-30 glass-panel rounded-2xl p-4 w-72 opacity-0 pointer-events-none transition-all duration-300 translate-y-10 scale-95">
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="triggerAction('Upload')" class="glass-button p-3 rounded-xl flex flex-col items-center gap-2"><i class="fa-solid fa-cloud-arrow-up text-blue-400"></i><span class="text-xs">Upload</span></button>
                        <button onclick="triggerAction('Camera')" class="glass-button p-3 rounded-xl flex flex-col items-center gap-2"><i class="fa-solid fa-eye text-miro-accent"></i><span class="text-xs">Vision</span></button>
                        <button onclick="triggerAction('Sign')" class="glass-button p-3 rounded-xl flex flex-col items-center gap-2"><i class="fa-solid fa-hands text-yellow-400"></i><span class="text-xs">Sign</span></button>
                        <button onclick="triggerAction('Mouse')" class="glass-button p-3 rounded-xl flex flex-col items-center gap-2"><i class="fa-solid fa-arrow-pointer text-pink-400"></i><span class="text-xs">Mouse</span></button>
                        <button onclick="triggerAction('screen')" class="glass-button p-3 rounded-xl flex flex-col items-center gap-2"><i class="fa-solid fa-desktop text-purple-400"></i><span class="text-xs">Screen</span></button>
                        <button onclick="triggerAction('search')" class="glass-button p-3 rounded-xl flex flex-col items-center gap-2"><i class="fa-solid fa-globe text-green-400"></i><span class="text-xs">Search</span></button>
                    </div>
                </div>

                <div class="max-w-4xl mx-auto glass-panel rounded-2xl p-2 flex items-center gap-2">
                    <button id="plus-btn" class="w-10 h-10 rounded-xl bg-white/5 hover:bg-miro-accent/20 text-gray-400"><i class="fa-solid fa-plus"></i></button>
                    <input type="text" id="user-input" placeholder="Type here..." class="flex-1 bg-transparent border-none outline-none text-white h-10 px-2">
                    <button id="mic-btn" class="w-10 h-10 rounded-xl hover:bg-white/10" onclick="toggleVoiceMode()"><i class="fa-solid fa-microphone"></i></button>
                    <button id="send-btn" class="w-10 h-10 rounded-xl bg-miro-accent text-black"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </main>

    <script>
        const wsUrl = 'wss://unelaborated-pseudobankrupt-landon.ngrok-free.dev/ws';
        let websocket = null, recognition = null, isVoiceMode = false, visionActive = false, stream = null;
        const video = document.getElementById("webcam"), fileInput = document.getElementById("file-upload");

        // Parse User ID from URL (Login Flow)
        const urlParams = new URLSearchParams(window.location.search);
        const uid = urlParams.get('uid') || "guest";
        const uname = urlParams.get('name') || "Guest";
        document.getElementById('user-display-name').innerText = uname;

        function connectWebSocket() {
            websocket = new WebSocket(wsUrl);
            websocket.onopen = () => { 
                // HANDSHAKE: Send User ID
                websocket.send(JSON.stringify({ type: "init", uid: uid }));
            };
            websocket.onmessage = (event) => {
                const text = event.data;
                addAiMessage(text);
                speak(text);
                if (text.includes("Vision Camera")) startVision();
            };
            websocket.onclose = () => setTimeout(connectWebSocket, 3000);
        }

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => websocket.send(JSON.stringify({ type: "upload", filename: file.name, file: event.target.result, mime: file.type }));
            reader.readAsDataURL(file);
        });

        document.getElementById('plus-btn').addEventListener('click', () => {
            document.getElementById('feature-picker').classList.toggle('opacity-0');
            document.getElementById('feature-picker').classList.toggle('pointer-events-none');
            document.getElementById('feature-picker').classList.toggle('translate-y-10');
        });

        window.triggerAction = (a) => {
            if(a==="Upload"){fileInput.click(); return;}
            if(a==="screen"){websocket.send("see screen"); return;}
            if(a==="search"){let q=prompt("Search"); if(q)websocket.send("search "+q); return;}
            websocket.send("activate "+a);
        };

        document.getElementById('send-btn').addEventListener('click', () => {
            const val = document.getElementById('user-input').value;
            if(val) { websocket.send(val); document.getElementById('user-input').value=''; addUserMessage(val); }
        });

        function addUserMessage(t){ const d=document.createElement('div'); d.className="flex justify-end"; d.innerHTML=`<div class="msg-user px-4 py-2 rounded-xl text-sm">${t}</div>`; document.getElementById('chat-container').appendChild(d); }
        function addAiMessage(t){ const d=document.createElement('div'); d.className="flex justify-start"; d.innerHTML=`<div class="msg-ai px-4 py-2 rounded-xl text-sm">${t}</div>`; document.getElementById('chat-container').appendChild(d); }
        function speak(t){ window.speechSynthesis.speak(new SpeechSynthesisUtterance(t.replace(/[*#]/g,''))); }
        function toggleVoiceMode(){ isVoiceMode=!isVoiceMode; }
        async function startVision(){ try{ stream=await navigator.mediaDevices.getUserMedia({video:true}); video.srcObject=stream; document.getElementById('vision-container').style.display='block'; visionActive=true; }catch(e){} }

        connectWebSocket();
    </script>
</body>
</html>